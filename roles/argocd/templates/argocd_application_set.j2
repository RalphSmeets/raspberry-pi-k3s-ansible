{% for application_source_type in application_source.types %}
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: '{{ application_source.name | lower }}-{{ application_source_type.name }}'
  namespace: {{ argocd_namespace }}
  labels:
{{ platform_office_hour_support_devops_labels | to_nice_yaml(width=1337) | indent(4,true) }}
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
{% if application_source.is_organisation %}
    - matrix:
        generators:
          - scmProvider:
              github:
                allBranches: false 
                organization: '{{ application_source.organisation }}'
          - git:
              files:
{% for path in application_source_type.git_files_path %}
                - path: '{{ path }}'
{% endfor %}
{% raw %}
              repoURL: '{{ .url }}'
{% endraw %}
              revision: HEAD
              values:
                repoURL: '{% raw %}{{ .url }}{% endraw %}'
{% else %}
    - git:
        repoURL: {{ application_source.repo_url }}
        revision: HEAD
        files:
{% for path in application_source_type.git_files_path %}
          - path: '{{ path }}'
{% endfor %}
        values:
          repoURL: '{{ application_source.repo_url }}'
{% endif %}
  template:
    metadata:
      name: '{{ application_source.mapping.team }}-{{ application_source.mapping.application }}{{ application_source.mapping.suffix }}' 
    spec:
      destination:
        name: '{{ application_source.mapping.cluster }}'
        namespace: '{{ application_source.mapping.namespace }}'
      project: '{{ application_source.mapping.overlay }}'
{% if application_source_type.name == 'helm' %}
      source:
{% raw %}
        repoURL: '{{ .values.repoURL }}'
        path: "{{ index .path.segments 0 }}"
        plugin:
          env:
            - name: HELM_REPO_URL
              value: '{{ .chart.repo_url }}'
            - name: HELM_CHART_NAME
              value: '{{ .chart.name }}'
            - name: HELM_CHART_VERSION
              value: '{{ .chart.version }}'
            - name: HELM_VALUES_FILE
              value: '{{ .path.path }}/values.yaml'
{% endraw %}
{% elif application_source_type.name == 'helm-source' %}
      source:
{% raw %}
        repoURL: '{{ .values.repoURL }}'
        path: "{{ index .path.segments 0 }}"
        plugin:
          env:
            - name: HELM_APPLICATION
              value: '{{  index .path.segments 0 }}'
            - name: HELM_VALUES_FILE
              value: 'deployments/{{ index .path.segements 2 }}{{ has ( index .path.segments 2 ) ( list "development" "test" ) | ternary ( index .path.segments 2) "" }}/values.yaml'
{% endraw %}
{% else %}
      source:
{% raw %}
        repoURL: '{{ .values.repoURL }}'
{% endraw %}
        path: '{{ application_source.mapping.application }}/overlays/{{ application_source.mapping.overlay }}'
{% endif %}
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
{% endfor %}
