template:
    metadata:
      name: >-
        {{ .repository }}-{{ index .path.segments 0 }}{{ has ( index
        .path.segments 2 ) (list "development" ) | ternary ( last .path.segments
        | printf "-dev-%s" ) "" }}{{ has ( index .path.segments 2 ) (list "test"
        ) | ternary "-tst"  "" }}
    spec:
      destination:
        name: >-
          {{ has ( index .path.segments 2 ) ( list "production") | ternary
          "pro-cluster" "dev-cluster" }}
        namespace: >-
          {{ .repository }}{{ has ( index .path.segments 2 ) (list "development"
          ) | ternary "-dev" ""}}{{ has ( index .path.segments 2 ) (list "test")
          | ternary "-tst" "" }}{{ has ( index .path.segments 2 ) (list
          "acceptance" ) | ternary "-acc" "" }}{{ has ( index .path.segments 2 )
          (list "development") | ternary ( last .path.segments | printf "-%s" )
          "" }}
      project: '{{ index .path.segments 2 }}'
      source:
        path: '{{ index .path.segments 0 }}'
        plugin:
          env:
            - name: HELM_APPLICATION
              value: '{{ index .path.segments 0 }}'
            - name: HELM_VALUES_FILE
              value: >-
                deployments/{{ index .path.segments 2 }}{{ has ( index
                .path.segments 2 ) ( list "development" ) | ternary ( last
                path.segments | printf "/%s" ) "" }}/values.yaml
        repoURL: '{{ .values.repoURL }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
